<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./css/style.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Assistant:wght@200..800&family=Ubuntu+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap"
    rel="stylesheet">
  <link rel="icon" type="image/png" sizes="32x32" href="./img/icon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="./img/icon.png">
  <title>Twi-Bot KI Dashboard</title>
</head>

<body>
  <div class="container">

    <!-- ===================================================== -->
    <!-- INTRO / HEADER -->
    <!-- ===================================================== -->
    <header class="section intro">
      <h1>Twi-Bot Client</h1>
      <p>Interaktives Test-Dashboard für unsere KI-Pipeline: <strong>STT → LLM → TTS</strong>.</p>
      <p class="hint">API Endpoint: <code>https://one.beezlebug.com/ki-sprachbot</code></p>

      <h4>Schnellstart</h4>
      <ul>
        <li>Audio eingeben: Push-to-Talk oder Datei hochladen</li>
        <li>STT: Sprache in Text umwandeln</li>
        <li>LLM: Frage an das Sprachmodell stellen</li>
        <li>TTS: Antwort als Audio ausgeben</li>
      </ul>
    </header>

    <!-- ===================================================== -->
    <!-- DASHBOARD -->
    <!-- ===================================================== -->
    <section class="section dashboard">
      <h2>Live Dashboard</h2>
      <p class="hint">(Tipp: Mit der Leertaste Push-to-Talk starten/stoppen)</p>

      <div class="grid-2">
        <!-- Controls -->
        <div class="card">
          <button id="push-to-talk-begin" onclick="initPushToTalk()">Push-to-talk</button>
          <div id="ptt-info"></div>

          <div class="button-row">
            <!-- <button id="start" onclick="buttonListenForVoiceActivation()" disabled>Auf Wakeword lauschen</button> -->
            <button id="start-file" onclick="buttonProcessAudioForWakeWord()" disabled>Audio-Datei testen</button>
          </div>

          <label for="wake-word-model">Wakeword Modell</label>
          <select id="wake-word-model" onchange="updateModelSelection(this.value)">
            <option value="./models/hey_twi_bot_v3.onnx">Hey Twi-Bot V3</option>
            <option value="./models/hey_rhasspy_v0.1.onnx">Hey Rhasspy V0.1</option>
          </select>

          <label for="vad-threshold">VAD Schwelle <span id="vad-threshold-display"></span></label>
          <input type="range" id="vad-threshold" min="0" max="1" step="0.025" value="0.5"
            oninput="updateThresholdSlider(this)">

          <label for="speech-timeout-threshold">Silence Schwelle <span id="speech-timeout-threshold-display"></span></label>
          <input type="range" id="speech-timeout-threshold" min="0" max="1" step="0.025" value="0.5"
            oninput="updateThresholdSlider(this)">

          <div class="meter-wrapper">
            <label>VAD Level:</label>
            <div id="vad-meter-wrapper" class="meter">
              <div id="vad-meter" class="meter-fill"></div>
            </div>
            <span id="vad-meter-value">0.00</span>
          </div>

          <label for="wakeword-threshold">WakeWord Schwelle <span id="wakeword-threshold-display"></span></label>
          <input type="range" id="wakeword-threshold" min="0" max="1" step="0.025" value="0.5"
            oninput="updateThresholdSlider(this)">

          <div id="status" class="status">Idle</div>

          <div class="meter-wrapper">
            <label>Wakeword Level:</label>
            <div id="wakeword-meter-wrapper" class="meter">
              <div id="wakeword-meter" class="meter-fill"></div>
            </div>
            <span id="wakeword-meter-value">0.00</span>
          </div>
        </div>

        <!-- File Input -->
        <div class="card">
          <label for="file">Audio-Datei hochladen</label>
          <input id="file" type="file" accept="audio/*" oninput="updateAudioInputLabel()" />
          <audio id="inputPlayer" controls></audio>
          <label id="audio-player-label" for="inputPlayer"></label>
        </div>
      </div>
    </section>

    <!-- ===================================================== -->
    <!-- PIPELINE -->
    <!-- ===================================================== -->
    <section class="section pipeline">
      <h2>Pipeline Control</h2>
      <div class="grid-2">
        <div class="card">
          <button id="pipeline-start" onclick="startPipeline()">▶ Pipeline starten</button>
          <div class="button-row">
            <button id="clear" class="delete-button" onclick="clearAll()">Alles zurücksetzen</button>
            <button id="reset" class="delete-button" onclick="clearConversation()">Conversation löschen</button>
          </div>
          <p>Aktuelle Conversation: <span id="conversation">none</span></p>
        </div>
        <div class="card">
          <div id="final-wrapper" class="answer">
            <span id="final-text">(Antwort erscheint hier)</span>
          </div>
        </div>
      </div>
    </section>

    <!-- ===================================================== -->
    <!-- SPEECH TO TEXT -->
    <!-- ===================================================== -->
    <section class="section stt">
      <h2>Speech to Text</h2>
      <div class="grid-2">
        <div class="card">
          <label for="whisper-model">Modell auswählen</label>
          <select id="whisper-model">
            <option value="large-v3-turbo">Whisper Large V3 Turbo</option>
            <option value="large-v3-turbo-q5_0">Whisper Large V3 Turbo q5_0</option>
            <option value="small">Whisper Small (schnell)</option>
            <option value="medium">Whisper Medium</option>
          </select>
          <div class="button-row">
            <button onclick="startSTT()">Transkribieren</button>
            <button onclick="startEmotionSTT()">Emotion erkennen</button>
          </div>
        </div>
        <div class="card">
          <div id="stt-wrapper" class="answer">
            <span id="stt-text">(Hier erscheint die Transkription)</span>
          </div>
        </div>
      </div>
    </section>

    <!-- ===================================================== -->
    <!-- LARGE LANGUAGE MODEL -->
    <!-- ===================================================== -->
    <section class="section llm">
      <h2>Large Language Model</h2>
      <div class="grid-2">
        <div class="card">
          <input id="llm-question" placeholder="Deine Frage an den Chatbot" />
          <button id="llm-ask" onclick="startLLM()">➡ Frage stellen</button>
        </div>
        <div class="card">
          <div id="llm-wrapper" class="answer">
            <span id="llm-text">(Antwort des Chatbots erscheint hier)</span>
          </div>
        </div>
      </div>
    </section>

    <!-- ===================================================== -->
    <!-- TEXT TO SPEECH -->
    <!-- ===================================================== -->
    <section class="section tts">
      <h2>Text to Speech</h2>
      <div class="grid-2">
        <div class="card">
          <label for="tts-type">TTS Engine</label>
          <select id="tts-type" oninput="updateTTSOptions()">
            <option value="coqui">Coqui TTS (Thorsten)</option>
            <option value="piper">Piper TTS</option>
          </select>
          <input id="tts-input" type="text" placeholder="Text eingeben..." />

          <div id="piper-options" class="hidden">
            <label for="thorsten-emotion">Emotion</label>
            <select id="thorsten-emotion">
              <option value="0">Fröhlich</option>
              <option value="1">Wütend</option>
              <option value="2">Angewidert</option>
              <option value="3">Betrunken</option>
              <option value="4">Neutral</option>
              <option value="5">Schläfrig</option>
              <option value="6">Überrascht</option>
              <option value="7">Flüstern</option>
            </select>

            <label for="tts-speed">Geschwindigkeit</label>
            <input id="tts-speed" value="0.95">
          </div>

          <button onclick="startTTS()">➡ Audio generieren</button>
        </div>
        <div class="card">
          <div id="tts-wrapper" class="answer">
            <audio id="ttsPlayer" controls></audio>
            <span id="tts-text">(Hier wird das Audio angezeigt und abgespielt)</span>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- ===================================================== -->
  <!-- SCRIPTS -->
  <!-- ===================================================== -->
  <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
  <script src="./js/SilenceDetector.js"></script>
  <script src="./js/Cooldown.js"></script>
  <script src="./js/beezlebugAPI.js"></script>
  <script src="./js/MediaRecorder.js"></script>
  <script src="./js/pttController.js"></script>
  <script src="./js/OpenWakeWordController.js"></script>
  <script src="./js/PipelineController.js"></script>
  <script src="./js/app.js"></script>
</body>
</html>
